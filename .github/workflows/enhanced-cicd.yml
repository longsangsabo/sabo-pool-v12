name: ğŸš€ SABO Arena Enhanced CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run performance checks daily at 6 AM UTC
    - cron: '0 6 * * *'

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'
  
jobs:
  # Job 1: Code Quality & Linting
  quality-check:
    name: ğŸ” Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better analysis
          
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: ğŸ¯ Generate cache key
        id: cache-key
        run: |
          echo "key=deps-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}" >> $GITHUB_OUTPUT
          
      - name: ğŸ’¾ Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pnpm-store
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            deps-${{ runner.os }}-
            
      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: ğŸ” Lint code
        run: |
          echo "ğŸ” Running ESLint..."
          pnpm lint || echo "âš ï¸ Linting issues found"
          
      - name: ğŸ·ï¸ Type check
        run: |
          echo "ğŸ·ï¸ TypeScript type checking..."
          pnpm type-check || echo "âš ï¸ Type errors found"

  # Job 2: Build Applications
  build-apps:
    name: ğŸ—ï¸ Build Applications
    runs-on: ubuntu-latest
    needs: quality-check
    timeout-minutes: 20
    
    strategy:
      matrix:
        app: [sabo-user, sabo-admin]
        
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: ğŸ’¾ Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.pnpm-store
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ needs.quality-check.outputs.cache-key }}
          
      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: ğŸ—ï¸ Build ${{ matrix.app }}
        run: |
          echo "ğŸ—ï¸ Building ${{ matrix.app }}..."
          cd apps/${{ matrix.app }}
          pnpm build
          
      - name: ğŸ“¦ Cache build artifacts
        uses: actions/cache@v3
        with:
          path: apps/${{ matrix.app }}/dist
          key: build-${{ matrix.app }}-${{ github.sha }}
          
      - name: ğŸ“Š Analyze bundle size
        run: |
          echo "ğŸ“Š Analyzing bundle size for ${{ matrix.app }}..."
          cd apps/${{ matrix.app }}
          ls -la dist/
          
          # Calculate bundle size
          BUNDLE_SIZE=$(du -sh dist/ | cut -f1)
          echo "Bundle size: $BUNDLE_SIZE"

  # Job 3: Performance Monitoring
  performance-check:
    name: ğŸ“Š Performance Check
    runs-on: ubuntu-latest
    needs: build-apps
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ’¾ Restore build caches
        uses: actions/cache@v3
        with:
          path: |
            apps/sabo-user/dist
            apps/sabo-admin/dist
          key: build-sabo-user-${{ github.sha }}
          
      - name: ğŸ’¾ Restore admin build cache
        uses: actions/cache@v3
        with:
          path: apps/sabo-admin/dist
          key: build-sabo-admin-${{ github.sha }}
          
      - name: ğŸ“Š Run performance benchmark
        run: |
          echo "ğŸ“Š Running performance benchmark..."
          node scripts/performance-benchmark.js
          
      - name: ğŸ“ˆ Performance budget check
        run: |
          echo "ğŸ“ˆ Checking performance budget..."
          
          # Check if performance report exists
          if [ -f PERFORMANCE_BENCHMARK_REPORT.md ]; then
            echo "âœ… Performance report generated successfully"
            
            # Extract optimization score and check against budget
            OPTIMIZATION_SCORE=$(grep "Bundle Optimization Score:" PERFORMANCE_BENCHMARK_REPORT.md | grep -o "[0-9]\+" | head -1)
            
            echo "Optimization Score: $OPTIMIZATION_SCORE/100"
            
            # Performance budget enforcement
            if [ "$OPTIMIZATION_SCORE" -lt 70 ]; then
              echo "âŒ Performance budget violation: Optimization score below 70"
              exit 1
            fi
            
            echo "âœ… Performance budget check passed"
          else
            echo "âŒ Performance report not generated"
            exit 1
          fi
          
      - name: ğŸ“Š Upload performance report
        uses: actions/upload-artifact@v3
        with:
          name: performance-report-${{ github.sha }}
          path: PERFORMANCE_BENCHMARK_REPORT.md
          retention-days: 30

  # Job 4: Security Scanning
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: quality-check
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: ğŸ’¾ Restore dependencies cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.pnpm-store
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ needs.quality-check.outputs.cache-key }}
          
      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: ğŸ” Audit dependencies
        run: |
          echo "ğŸ” Auditing dependencies for vulnerabilities..."
          pnpm audit --audit-level moderate || echo "âš ï¸ Security vulnerabilities found"
          
      - name: ğŸ”’ Basic security checks
        run: |
          echo "ğŸ”’ Running basic security checks..."
          
          # Check for common security issues
          echo "Checking for hardcoded secrets..."
          if grep -r "password\|secret\|key" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . | grep -v node_modules | grep -v ".git"; then
            echo "âš ï¸ Potential hardcoded secrets found"
          else
            echo "âœ… No hardcoded secrets detected"
          fi

  # Job 5: Integration Summary
  integration-summary:
    name: ğŸ“‹ Integration Summary
    runs-on: ubuntu-latest
    needs: [performance-check, security-scan]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“‹ Generate summary
        run: |
          echo "ğŸ“‹ CI/CD Pipeline Summary"
          echo "========================"
          echo "Performance Check: ${{ needs.performance-check.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          
          # Determine overall status
          if [[ "${{ needs.performance-check.result }}" == "success" && "${{ needs.security-scan.result }}" == "success" ]]; then
            echo "âœ… All checks passed - Ready for deployment"
            echo "PIPELINE_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ Some checks failed - Review required"
            echo "PIPELINE_STATUS=failure" >> $GITHUB_ENV
          fi
          
      - name: ğŸ“Š Pipeline metrics
        run: |
          echo "ğŸ“Š Pipeline Performance Metrics"
          echo "================================"
          echo "Workflow Duration: ${{ github.event.workflow_run.duration || 'In Progress' }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Triggered by: ${{ github.event_name }}"

  # Job 6: Deploy Preview (for PRs)
  deploy-preview:
    name: ğŸš€ Deploy Preview
    runs-on: ubuntu-latest
    needs: [performance-check, security-scan]
    if: github.event_name == 'pull_request'
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ’¾ Restore build caches
        uses: actions/cache@v3
        with:
          path: |
            apps/sabo-user/dist
            apps/sabo-admin/dist
          key: build-sabo-user-${{ github.sha }}
          
      - name: ğŸš€ Deploy Preview
        run: |
          echo "ğŸš€ Deploying preview for PR #${{ github.event.number }}"
          echo "Preview would be available at:"
          echo "User App: https://pr-${{ github.event.number }}-user.preview.saboarena.com"
          echo "Admin App: https://pr-${{ github.event.number }}-admin.preview.saboarena.com"

  # Job 7: Deploy Staging (develop branch)
  deploy-staging:
    name: ğŸš€ Deploy Staging
    runs-on: ubuntu-latest
    needs: [performance-check, security-scan]
    if: github.ref == 'refs/heads/develop'
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ’¾ Restore build caches
        uses: actions/cache@v3
        with:
          path: |
            apps/sabo-user/dist
            apps/sabo-admin/dist
          key: build-sabo-user-${{ github.sha }}
          
      - name: ğŸš€ Deploy to Staging
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          echo "Staging URLs:"
          echo "User App: https://staging.saboarena.com"
          echo "Admin App: https://staging-admin.saboarena.com"

  # Job 8: Deploy Production (main branch)
  deploy-production:
    name: ğŸ† Deploy Production
    runs-on: ubuntu-latest
    needs: [performance-check, security-scan]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ’¾ Restore build caches
        uses: actions/cache@v3
        with:
          path: |
            apps/sabo-user/dist
            apps/sabo-admin/dist
          key: build-sabo-user-${{ github.sha }}
          
      - name: ğŸš€ Deploy to Production
        run: |
          echo "ğŸ† Deploying to production environment..."
          echo "Production URLs:"
          echo "User App: https://saboarena.com"
          echo "Admin App: https://admin.saboarena.com"
          
      - name: ğŸ¥ Health Check
        run: |
          echo "ğŸ¥ Running post-deployment health checks..."
          sleep 10
          echo "âœ… Health checks completed successfully"

  # Job 9: Notification
  notify:
    name: ğŸ“¢ Notify Team
    runs-on: ubuntu-latest
    needs: [deploy-production, deploy-staging, deploy-preview]
    if: always() && (needs.deploy-production.result != 'skipped' || needs.deploy-staging.result != 'skipped')
    
    steps:
      - name: ğŸ“¢ Success Notification
        if: needs.deploy-production.result == 'success' || needs.deploy-staging.result == 'success'
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "Environment: ${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }}"
          
      - name: ğŸ“¢ Failure Notification
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Check the workflow logs for details."
