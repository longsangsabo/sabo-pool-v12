<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crop Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .image-container { 
            position: relative; 
            width: 400px; 
            height: 400px; 
            border: 2px solid #333; 
            margin: 20px auto;
            background: #000;
        }
        .image-container img { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
        }
        .crop-overlay {
            position: absolute;
            border: 2px solid #00ff00;
            background: rgba(0, 255, 0, 0.1);
            pointer-events: none;
        }
        .info { 
            background: #f5f5f5; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        #result canvas { border: 1px solid #ccc; margin: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ðŸ”§ Crop Calculation Debug</h2>
        
        <input type="file" id="fileInput" accept="image/*">
        <button onclick="simulateCrop()">Simulate Crop</button>
        <button onclick="reset()">Reset</button>
        
        <div class="image-container" id="imageContainer" style="display: none;">
            <img id="testImage" alt="Test image">
            <div class="crop-overlay" id="cropOverlay"></div>
        </div>
        
        <div class="info" id="calculations" style="display: none;">
            <strong>ðŸ“Š Calculations:</strong><br>
            <div id="calcDetails"></div>
        </div>
        
        <div id="result" style="text-align: center; display: none;">
            <h4>Cropped Result:</h4>
            <canvas id="resultCanvas" width="200" height="200"></canvas>
        </div>
    </div>

    <script>
        let currentImage = null;

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    currentImage = img;
                    showImage(e.target.result);
                    calculateCropArea();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        function showImage(src) {
            const container = document.getElementById('imageContainer');
            const testImg = document.getElementById('testImage');
            testImg.src = src;
            container.style.display = 'block';
        }

        function calculateCropArea() {
            if (!currentImage) return;

            const container = document.getElementById('imageContainer');
            const containerRect = { width: 400, height: 400 }; // Fixed container size

            // Calculate object-contain dimensions
            const imageAspectRatio = currentImage.width / currentImage.height;
            const containerAspectRatio = containerRect.width / containerRect.height;

            let displayedWidth, displayedHeight, offsetX, offsetY;

            if (imageAspectRatio > containerAspectRatio) {
                // Image is wider - fits by width
                displayedWidth = containerRect.width;
                displayedHeight = containerRect.width / imageAspectRatio;
                offsetX = 0;
                offsetY = (containerRect.height - displayedHeight) / 2;
            } else {
                // Image is taller - fits by height
                displayedHeight = containerRect.height;
                displayedWidth = containerRect.height * imageAspectRatio;
                offsetX = (containerRect.width - displayedWidth) / 2;
                offsetY = 0;
            }

            // Create crop area (80% of displayed image, centered)
            const cropSize = Math.min(displayedWidth, displayedHeight) * 0.8;
            const cropX = offsetX + (displayedWidth - cropSize) / 2;
            const cropY = offsetY + (displayedHeight - cropSize) / 2;

            // Show crop overlay
            const overlay = document.getElementById('cropOverlay');
            overlay.style.left = cropX + 'px';
            overlay.style.top = cropY + 'px';
            overlay.style.width = cropSize + 'px';
            overlay.style.height = cropSize + 'px';

            // Calculate source coordinates
            const scaleX = currentImage.width / displayedWidth;
            const scaleY = currentImage.height / displayedHeight;
            const sourceX = (cropX - offsetX) * scaleX;
            const sourceY = (cropY - offsetY) * scaleY;
            const sourceSize = cropSize * scaleX;

            // Show calculations
            const calcDiv = document.getElementById('calcDetails');
            calcDiv.innerHTML = `
                Natural Image: ${currentImage.width} x ${currentImage.height}<br>
                Container: ${containerRect.width} x ${containerRect.height}<br>
                Image Aspect: ${imageAspectRatio.toFixed(3)}<br>
                Container Aspect: ${containerAspectRatio.toFixed(3)}<br>
                <br>
                Displayed Size: ${displayedWidth.toFixed(1)} x ${displayedHeight.toFixed(1)}<br>
                Display Offset: (${offsetX.toFixed(1)}, ${offsetY.toFixed(1)})<br>
                <br>
                Crop Area: (${cropX.toFixed(1)}, ${cropY.toFixed(1)}) ${cropSize.toFixed(1)} x ${cropSize.toFixed(1)}<br>
                <br>
                Scale Factors: ${scaleX.toFixed(3)} x ${scaleY.toFixed(3)}<br>
                Source Area: (${sourceX.toFixed(1)}, ${sourceY.toFixed(1)}) ${sourceSize.toFixed(1)} x ${sourceSize.toFixed(1)}<br>
            `;
            document.getElementById('calculations').style.display = 'block';

            // Store for simulation
            window.cropData = {
                sourceX, sourceY, sourceSize,
                cropX, cropY, cropSize,
                displayedWidth, displayedHeight, offsetX, offsetY
            };
        }

        function simulateCrop() {
            if (!currentImage || !window.cropData) return;

            const canvas = document.getElementById('resultCanvas');
            const ctx = canvas.getContext('2d');
            const { sourceX, sourceY, sourceSize } = window.cropData;

            // Clear and draw cropped area
            ctx.clearRect(0, 0, 200, 200);
            ctx.drawImage(
                currentImage,
                sourceX, sourceY, sourceSize, sourceSize,
                0, 0, 200, 200
            );

            document.getElementById('result').style.display = 'block';
        }

        function reset() {
            document.getElementById('imageContainer').style.display = 'none';
            document.getElementById('calculations').style.display = 'none';
            document.getElementById('result').style.display = 'none';
            document.getElementById('fileInput').value = '';
            currentImage = null;
            window.cropData = null;
        }
    </script>
</body>
</html>
